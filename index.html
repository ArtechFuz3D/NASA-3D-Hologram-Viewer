<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NASA 3D Hologram Viewer</title>
  <meta name="description" content="Interactive holographic viewer for NASA 3D models using Three.js." />
  <meta name="author" content="ArtechFuz3D" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
    canvas.webgl {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh; display: block;
    }
    #ui {
      position: fixed; top: 1.5rem; left: 50%;
      transform: translateX(-50%);
      z-index: 10; display: flex;
      flex-direction: column; align-items: center; gap: 0.5rem;
    }
    h1 {
      color: #70c1ff; font-size: 0.75rem;
      letter-spacing: 0.3em; text-transform: uppercase;
      text-shadow: 0 0 12px #70c1ff88;
    }
    #modelSelect {
      background: rgba(0,10,30,0.85);
      border: 1px solid #70c1ff55;
      color: #70c1ff; font-family: 'Courier New', monospace;
      font-size: 0.8rem; padding: 0.4rem 0.8rem;
      border-radius: 3px; outline: none; cursor: pointer;
      max-width: 380px; width: 90vw;
      box-shadow: 0 0 20px #70c1ff22, inset 0 0 10px #70c1ff11;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #modelSelect:hover, #modelSelect:focus {
      border-color: #70c1ffaa;
      box-shadow: 0 0 30px #70c1ff44, inset 0 0 12px #70c1ff22;
    }
    #modelSelect option { background: #000d1a; color: #70c1ff; }
    #status {
      color: #70c1ff88; font-size: 0.65rem;
      letter-spacing: 0.15em; min-height: 1em;
      text-shadow: 0 0 8px #70c1ff44;
    }
    body::after {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 5;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px,
        rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px);
    }
    body::before {
      content: ''; position: fixed; inset: 1rem;
      border: 1px solid #70c1ff18; pointer-events: none; z-index: 6;
    }
  </style>
</head>
<body>
  <div id="ui">
    <h1>NASA 3D Hologram Viewer</h1>
    <select id="modelSelect"><option value="">Fetching NASA models…</option></select>
    <div id="status"></div>
  </div>
  <canvas class="webgl"></canvas>

  <!--
    Using classic UMD/global <script> tags instead of ES modules.
    This avoids ALL "Failed to resolve module specifier" errors on GH Pages
    because there is no bundler and no import maps.
    Three.js globals: THREE, THREE.OrbitControls, THREE.GLTFLoader, etc.
  -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/FBXLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/TDSLoader.js"></script>
  <!-- fflate is required by FBXLoader -->
  <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>

  <script>
    /* ===================== SHADERS ===================== */
    var vert = [
      'uniform float uTime;',
      'varying vec3 vNormal;',
      'varying vec3 vPosition;',
      'void main() {',
      '  vNormal   = normalize(normalMatrix * normal);',
      '  vPosition = position;',
      '  vec3 pos  = position + normal * sin(uTime * 2.0 + position.y * 10.0) * 0.002;',
      '  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);',
      '}'
    ].join('\n');

    var frag = [
      'uniform float uTime;',
      'uniform vec3  uColor;',
      'varying vec3  vNormal;',
      'varying vec3  vPosition;',
      'void main() {',
      '  float scanline = sin(vPosition.y * 80.0 + uTime * 3.0) * 0.5 + 0.5;',
      '  float fresnel  = pow(1.0 - abs(dot(normalize(vNormal), vec3(0.0,0.0,1.0))), 2.0);',
      '  float alpha    = (scanline * 0.4 + fresnel * 0.6) * 0.85;',
      '  gl_FragColor   = vec4(uColor, alpha);',
      '}'
    ].join('\n');

    /* ===================== SCENE ===================== */
    var canvas   = document.querySelector('.webgl');
    var scene    = new THREE.Scene();
    var camera   = new THREE.PerspectiveCamera(25, innerWidth / innerHeight, 0.1, 1000);
    camera.position.set(6, 4, 6);

    var renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

    var controls = new THREE.OrbitControls(camera, canvas);
    controls.enableDamping = true;

    window.addEventListener('resize', function () {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    /* ===================== MATERIAL ===================== */
    var material = new THREE.ShaderMaterial({
      vertexShader:   vert,
      fragmentShader: frag,
      uniforms: {
        uTime:  { value: 0 },
        uColor: { value: new THREE.Color('#70c1ff') }
      },
      transparent: true,
      wireframe:   true,
      depthWrite:  false,
      blending:    THREE.AdditiveBlending,
      side:        THREE.DoubleSide
    });

    /* ===================== MODEL HELPERS ===================== */
    var statusEl = document.getElementById('status');
    function setStatus(msg) { statusEl.textContent = msg; }

    var currentModel = null;

    function disposeModel() {
      if (!currentModel) return;
      scene.remove(currentModel);
      currentModel.traverse(function (o) { if (o.geometry) o.geometry.dispose(); });
      currentModel = null;
    }

    function applyMaterial(obj) {
      obj.traverse(function (c) { if (c.isMesh) c.material = material; });
    }

    function centerAndScale(obj) {
      var box  = new THREE.Box3().setFromObject(obj);
      var size = box.getSize(new THREE.Vector3());
      var max  = Math.max(size.x, size.y, size.z) || 1;
      var s    = 3 / max;
      obj.scale.setScalar(s);
      var center = box.getCenter(new THREE.Vector3());
      obj.position.sub(center.multiplyScalar(s));
    }

    function loadModel(url) {
      disposeModel();
      setStatus('Loading…');
      var ext = url.split('?')[0].split('.').pop().toLowerCase();

      function onLoad(data) {
        if (data && data.scene) {
          currentModel = data.scene;
        } else if (data && data.isBufferGeometry) {
          currentModel = new THREE.Mesh(data, material);
        } else {
          currentModel = data;
        }
        if (!currentModel) { setStatus('Could not parse model.'); return; }
        applyMaterial(currentModel);
        centerAndScale(currentModel);
        scene.add(currentModel);
        setStatus('');
      }

      function onProgress(xhr) {
        if (xhr.total) setStatus('Loading… ' + Math.round(xhr.loaded / xhr.total * 100) + '%');
      }

      function onError(err) {
        console.error(err);
        setStatus('Failed to load — CORS or format issue.');
      }

      if (ext === 'glb' || ext === 'gltf') {
        new THREE.GLTFLoader().load(url, onLoad, onProgress, onError);
      } else if (ext === 'fbx') {
        new THREE.FBXLoader().load(url, onLoad, onProgress, onError);
      } else if (ext === 'stl') {
        new THREE.STLLoader().load(url, onLoad, onProgress, onError);
      } else if (ext === '3ds') {
        new THREE.TDSLoader().load(url, onLoad, onProgress, onError);
      } else {
        setStatus('Unsupported format: ' + ext);
      }
    }

    /* ===================== NASA MODEL LIST ===================== */
    var select     = document.getElementById('modelSelect');
    var VALID_EXT  = ['glb','gltf','fbx','stl','3ds'];
    var BASE_RAW   = 'https://raw.githubusercontent.com/nasa/NASA-3D-Resources/master/';

    // Reliable curated fallback (always shown if GitHub API fails / rate-limited)
    var CURATED = [
      { name: 'Curiosity Rover (STL)',         path: 'Models/Curiosity/MSL_Rover.STL' },
      { name: 'Hubble Space Telescope (3DS)',   path: 'Models/Hubble_Space_Telescope/hubble_space_telescope_2002.3ds' },
      { name: 'Mars Pathfinder Lander (3DS)',   path: 'Models/Mars_Pathfinder_Lander/mars_pathfinder_lander.3ds' },
      { name: 'Voyager (3DS)',                  path: 'Models/Voyager/voyager.3ds' },
      { name: 'Cassini (3DS)',                  path: 'Models/Cassini/cassini.3ds' },
      { name: 'New Horizons (3DS)',             path: 'Models/New_Horizons/new_horizons.3ds' },
      { name: 'Dawn Spacecraft (3DS)',          path: 'Models/Dawn/dawn.3ds' },
      { name: 'Space Shuttle (3DS)',            path: 'Models/Space_Shuttle/space_shuttle.3ds' },
      { name: 'Apollo Command Module (3DS)',    path: 'Models/Apollo_11_Command_Module/command_module.3ds' },
    ];

    function populateSelect(models) {
      select.innerHTML = '<option value="">— Select a model —</option>';
      models.forEach(function (m) {
        var o      = document.createElement('option');
        o.value    = BASE_RAW + m.path;
        o.textContent = m.name || m.path.split('/').pop();
        select.appendChild(o);
      });
      setStatus(models.length + ' models available');
    }

    function fetchNASAModels() {
      setStatus('Fetching model list from GitHub…');

      // Step 1: get master branch tree SHA
      fetch('https://api.github.com/repos/nasa/NASA-3D-Resources/branches/master', {
        headers: { Accept: 'application/vnd.github+json' }
      })
      .then(function (r) {
        if (!r.ok) throw new Error('Branch API returned ' + r.status);
        return r.json();
      })
      .then(function (branch) {
        var sha = branch.commit.commit.tree.sha;
        // Step 2: recursive tree
        return fetch(
          'https://api.github.com/repos/nasa/NASA-3D-Resources/git/trees/' + sha + '?recursive=1',
          { headers: { Accept: 'application/vnd.github+json' } }
        );
      })
      .then(function (r) {
        if (!r.ok) throw new Error('Tree API returned ' + r.status);
        return r.json();
      })
      .then(function (data) {
        var tree   = data.tree || [];
        var models = tree
          .filter(function (f) {
            return f.type === 'blob' &&
              VALID_EXT.some(function (e) { return f.path.toLowerCase().endsWith('.' + e); });
          })
          .map(function (f) {
            return { name: f.path.split('/').pop(), path: f.path };
          });

        if (models.length === 0) throw new Error('No 3D model files found in tree');

        populateSelect(models);
        if (data.truncated) setStatus('Tree truncated — showing ' + models.length + ' models found');
      })
      .catch(function (err) {
        console.warn('GitHub API failed (' + err.message + '), using curated list');
        populateSelect(CURATED);
        setStatus('GitHub API unavailable — showing curated list');
      });
    }

    fetchNASAModels();
    select.addEventListener('change', function (e) {
      if (e.target.value) loadModel(e.target.value);
    });

    /* ===================== RENDER LOOP ===================== */
    var clock = new THREE.Clock();
    (function tick() {
      material.uniforms.uTime.value = clock.getElapsedTime();
      if (currentModel) currentModel.rotation.y += 0.003;
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(tick);
    })();
  </script>
</body>
</html>
